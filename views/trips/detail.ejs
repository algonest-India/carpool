<%-
/**
 * Trip Detail Page - Carpool Connect
 * 
 * This EJS template renders the detailed view of a single trip, displaying comprehensive
 * information about the trip, driver, passengers, and interactive map visualization.
 * 
 * Features:
 * - Enhanced header with route badges and metadata
 * - Interactive map with route visualization
 * - Driver information with avatar and ratings
 * - Passenger list and booking functionality
 * - Route statistics (distance, duration, speed)
 * - Responsive design with modern UI components
 * - Error handling and user feedback
 * - Booking form with validation
 * 
 * Data Available:
 * - trip: Trip object with all trip details
 * - user: Current user object (if logged in)
 * - bookings: Array of passenger bookings
 * - profiles: Driver profile information
 * 
 * Author: Carpool Connect Team
 * Version: 1.0.0
 */
-%>

<!-- Enhanced Header Section -->
<link rel="stylesheet" href="/css/trip-detail-enhanced.css">

<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-start">
      <div class="flex-grow-1">
        <!-- Back Navigation -->
        <div class="mb-3">
          <a href="/trips" class="btn btn-outline-primary btn-sm rounded-pill px-3 py-2">
            <i class="fas fa-arrow-left me-2"></i>Back to Trips
          </a>
        </div>
        
        <!-- Trip Title with Route Badges -->
        <div class="trip-header-content">
          <h1 class="trip-title mb-3">
            <div class="route-badges d-flex align-items-center flex-wrap gap-2 mb-2">
              <!-- Origin Badge -->
              <span class="badge bg-gradient-primary text-white px-3 py-2 rounded-pill">
                <i class="fas fa-map-marker-alt me-1"></i> <%= trip.origin_text %>
              </span>
              
              <!-- Route Arrow -->
              <span class="route-arrow text-muted mx-2">
                <i class="fas fa-long-arrow-alt-right"></i>
              </span>
              
              <!-- Destination Badge -->
              <span class="badge bg-gradient-danger text-white px-3 py-2 rounded-pill">
                <i class="fas fa-flag-checkered me-1"></i> <%= trip.destination_text %>
              </span>
            </div>
          </h1>
          
          <!-- Trip Metadata (Date, Time, Seats, Price) -->
          <div class="trip-meta d-flex align-items-center flex-wrap gap-3">
            <!-- Departure Date -->
            <div class="meta-item">
              <i class="fas fa-calendar-alt text-primary me-2"></i>
              <span class="text-muted">Departure:</span>
              <strong class="ms-1"><%= new Date(trip.departure_timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></strong>
            </div>
            
            <!-- Departure Time -->
            <div class="meta-item">
              <i class="fas fa-clock text-info me-2"></i>
              <span class="text-muted">Time:</span>
              <strong class="ms-1"><%= new Date(trip.departure_timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></strong>
            </div>
            <div class="meta-item">
              <i class="fas fa-users text-success me-2"></i>
              <span class="text-muted">Seats:</span>
              <strong class="ms-1"><%= trip.available_seats %> available</strong>
            </div>
            <div class="meta-item">
              <i class="fas fa-rupee-sign text-warning me-2"></i>
              <span class="text-muted">Price:</span>
              <strong class="ms-1"><%= trip.price ? '‚Çπ' + parseFloat(trip.price).toFixed(2) : 'Free' %></strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-lg border-0 mb-4">
      <div class="card-header bg-gradient-primary text-white">
        <h2 class="mb-0"><i class="fas fa-route me-2"></i>Trip Information</h2>
      </div>
      <div class="card-body p-4">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-3">
              <div class="icon-box bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-calendar-alt text-primary"></i>
              </div>
              <div>
                <div class="text-muted small">Departure Date</div>
                <strong><%= new Date(trip.departure_timestamp).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %></strong>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-3">
              <div class="icon-box bg-info bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-clock text-info"></i>
              </div>
              <div>
                <div class="text-muted small">Departure Time</div>
                <strong><%= new Date(trip.departure_timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></strong>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-3">
              <div class="icon-box bg-success bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-users text-success"></i>
              </div>
              <div>
                <div class="text-muted small">Available Seats</div>
                <strong class="text-success"><%= trip.available_seats %> Seat<%= trip.available_seats !== 1 ? 's' : '' %></strong>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-3">
              <div class="icon-box bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-rupee-sign text-warning"></i>
              </div>
              <div>
                <div class="text-muted small">Price per Seat</div>
                <% if (trip.price) { %>
                  <strong class="text-success">‚Çπ<%= parseFloat(trip.price).toFixed(2) %></strong>
                <% } else { %>
                  <strong class="text-success">Free</strong>
                <% } %>
              </div>
            </div>
          </div>
        </div>
        
        <% if (trip.description) { %>
        <div class="border-top pt-3">
          <div class="d-flex align-items-start">
            <div class="icon-box bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
              <i class="fas fa-info-circle text-secondary"></i>
            </div>
            <div>
              <div class="text-muted small mb-2">Description</div>
              <p class="mb-0"><%= trip.description %></p>
            </div>
          </div>
        </div>
        <% } %>
      </div>
    </div>

    <div class="card shadow-lg border-0 mb-4">
      <div class="card-header bg-gradient-info text-white">
        <h2 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Route Visualization</h2>
      </div>
      <div class="card-body p-4">
        <div class="row mb-3">
          <div class="col-md-8">
            <div class="d-flex align-items-center mb-3">
              <div class="icon-box bg-info bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-route text-info"></i>
              </div>
              <div>
                <div class="text-muted small">Total Distance</div>
                <strong class="text-info"><%= trip.route_geojson && trip.route_geojson.properties ? 
                  (trip.route_geojson.properties.distance / 1000).toFixed(1) + ' km' : 
                  'N/A' %></strong>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center mb-3">
              <div class="icon-box bg-success bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-clock text-success"></i>
              </div>
              <div>
                <div class="text-muted small">Estimated Duration</div>
                <strong class="text-success"><%= trip.route_geojson && trip.route_geojson.properties ? 
                  Math.round(trip.route_geojson.properties.duration / 60) + ' min' : 
                  'N/A' %></strong>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <div class="d-flex align-items-center mb-3">
              <div class="icon-box bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-tachometer-alt text-warning"></i>
              </div>
              <div>
                <div class="text-muted small">Average Speed</div>
                <strong class="text-warning"><%= trip.route_geojson && trip.route_geojson.properties ? 
                  ((trip.route_geojson.properties.distance / 1000) / (trip.route_geojson.properties.duration / 3600) * 60).toFixed(1) + ' km/h' : 
                  'N/A' %></strong>
              </div>
            </div>
          </div>
        </div>
        
        <div id="map" class="map-large enhanced-map" role="application" aria-label="Interactive route map with detailed visualization"></div>
        
        <% if (trip.route_geojson && trip.route_geojson.geometry && trip.route_geojson.geometry.coordinates && trip.route_geojson.geometry.coordinates.length >= 2) { %>
          <div class="p-3 border-top">
            <div class="row">
              <div class="col-md-6">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-box bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                    <i class="fas fa-map-marker-alt text-primary"></i>
                  </div>
                  <div>
                    <div class="text-muted small">Origin Point</div>
                    <strong>Lat: <%= trip.route_geojson.geometry.coordinates[0][1].toFixed(6) %>, Lng: <%= trip.route_geojson.geometry.coordinates[0][0].toFixed(6) %></strong>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-box bg-danger bg-opacity-10 rounded-circle p-2 me-3">
                    <i class="fas fa-flag-checkered text-danger"></i>
                  </div>
                  <div>
                    <div class="text-muted small">Destination Point</div>
                    <% const lastCoord = trip.route_geojson.geometry.coordinates[trip.route_geojson.geometry.coordinates.length - 1]; %>
                    <strong>Lat: <%= lastCoord[1].toFixed(6) %>, Lng: <%= lastCoord[0].toFixed(6) %></strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } else { %>
          <div class="p-3 text-center text-muted">
            <div class="mb-3">
              <i class="fas fa-map-marked-alt fa-2x mb-2"></i>
              <p class="mb-0">Route map will be displayed here when available</p>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Route Information:</strong> No detailed route data available. The trip will be created with basic route information.
            </div>
          </div>
        <% } %>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-header bg-success text-white">
        <h2 class="mb-0"><i class="fas fa-users me-2"></i>Passengers (<%= trip.bookings ? trip.bookings.length : 0 %>)</h2>
      </div>
      <div class="card-body p-4">
        <% if (trip.bookings && trip.bookings.length > 0) { %>
          <div class="row">
            <% trip.bookings.forEach(function(booking) { %>
              <div class="col-md-4 col-lg-3 mb-3">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="card-body text-center p-3">
                    <% if (booking.profiles && booking.profiles.avatar_url) { %>
                      <img src="<%= booking.profiles.avatar_url %>" alt="<%= booking.profiles.full_name %>" class="avatar-md rounded-circle mb-2">
                    <% } else { %>
                      <div class="avatar-md placeholder-avatar mx-auto mb-2">üë§</div>
                    <% } %>
                    <h6 class="mb-0"><%= booking.profiles.full_name %></h6>
                    <small class="text-muted">Passenger</small>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="text-center py-4">
            <div class="emoji-xl text-muted mb-2">üöó</div>
            <h6 class="text-muted">No passengers yet</h6>
            <p class="text-muted small mb-0">Be the first to join this trip!</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-lg border-0 sticky-card mb-4">
      <div class="card-header bg-gradient-warning text-dark">
        <h4 class="mb-0"><i class="fas fa-user-tie me-2"></i>Driver Information</h4>
      </div>
      <div class="card-body p-4">
        <div class="text-center mb-4">
          <div class="driver-avatar-container position-relative d-inline-block">
            <% if (trip.profiles && trip.profiles.avatar_url) { %>
              <img src="<%= trip.profiles.avatar_url %>" alt="<%= trip.profiles.full_name || 'Driver' %>" class="avatar-lg shadow-sm" style="width: 120px; height: 120px; object-fit: cover; border-radius: 50%;">
              <div class="avatar-badge position-absolute top-0 end-0 bg-success rounded-circle p-1">
                <i class="fas fa-check text-white" style="font-size: 12px;"></i>
              </div>
            <% } else { %>
              <div class="avatar-lg placeholder-avatar mx-auto shadow-sm position-relative" style="width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; font-size: 3rem;">
                üë§
                <div class="avatar-badge position-absolute top-0 end-0 bg-success rounded-circle p-1">
                  <i class="fas fa-check text-white" style="font-size: 12px;"></i>
                </div>
              </div>
            <% } %>
          </div>
        </div>
        
        <div class="driver-info text-center mb-4">
          <h5 class="driver-name mb-2"><%= trip.profiles ? trip.profiles.full_name : 'Driver Name' %></h5>
          <div class="driver-rating mb-3">
            <div class="stars">
              <i class="fas fa-star text-warning"></i>
              <i class="fas fa-star text-warning"></i>
              <i class="fas fa-star text-warning"></i>
              <i class="fas fa-star text-warning"></i>
              <i class="fas fa-star-half-alt text-warning"></i>
              <span class="ms-2 text-muted small">4.8 (127 reviews)</span>
            </div>
          </div>
          <div class="verification-badge">
            <span class="badge bg-success text-white px-3 py-1 rounded-pill">
              <i class="fas fa-shield-alt me-1"></i>Verified Driver
            </span>
          </div>
        </div>
        
        <% if (trip.profiles && trip.profiles.bio) { %>
        <div class="driver-bio mb-4">
          <div class="d-flex align-items-start mb-2">
            <i class="fas fa-info-circle text-muted me-2 mt-1"></i>
            <div>
              <div class="text-muted small mb-1">About</div>
              <p class="mb-0 small text-secondary"><%= trip.profiles.bio %></p>
            </div>
          </div>
        </div>
        <% } %>
        
        <% if (trip.profiles && trip.profiles.phone) { %>
        <div class="driver-contact mb-4">
          <div class="d-flex align-items-center mb-2">
            <i class="fas fa-phone text-muted me-2"></i>
            <span class="small"><%= trip.profiles.phone %></span>
          </div>
        </div>
        <% } %>
        
        <div class="driver-stats mb-4">
          <div class="row text-center">
            <div class="col-4">
              <div class="stat-item">
                <div class="stat-number text-primary fw-bold">152</div>
                <div class="stat-label small text-muted">Trips</div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-item">
                <div class="stat-number text-success fw-bold">98%</div>
                <div class="stat-label small text-muted">On-time</div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-item">
                <div class="stat-number text-info fw-bold">4.8</div>
                <div class="stat-label small text-muted">Rating</div>
              </div>
            </div>
          </div>
        </div>

        <div class="booking-section">
          <% if (user) { %>
            <% if (user.id === trip.driver_id) { %>
              <div class="alert alert-success mb-3 border-0 shadow-sm">
                <div class="d-flex align-items-center">
                  <i class="fas fa-check-circle me-2"></i>
                  <div>
                    <strong>You are the driver of this trip</strong>
                    <div class="small text-muted">Manage your trip settings</div>
                  </div>
                </div>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-outline-secondary w-100" disabled>
                  <i class="fas fa-lock me-2"></i>Your Trip
                </button>
                <button class="btn btn-outline-primary w-100">
                  <i class="fas fa-cog me-2"></i>Manage Trip
                </button>
              </div>
            <% } else if (trip.available_seats > 0) { %>
              <div class="booking-info mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-muted small">Available Seats</span>
                  <span class="badge bg-success text-white"><%= trip.available_seats %> left</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted small">Price per Seat</span>
                  <span class="fw-bold text-primary"><%= trip.price ? '‚Çπ' + parseFloat(trip.price).toFixed(2) : 'Free' %></span>
                </div>
              </div>
              <form action="/trips/<%= trip.id %>/book" method="POST">
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-ticket-alt me-2"></i>Book a Seat
                  </button>
                  <button type="button" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-comment me-2"></i>Contact Driver
                  </button>
                </div>
              </form>
            <% } else { %>
              <div class="alert alert-warning mb-3 border-0 shadow-sm">
                <div class="d-flex align-items-center">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <div>
                    <strong>No seats available</strong>
                    <div class="small text-muted">This trip is fully booked</div>
                  </div>
                </div>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-secondary w-100" disabled>
                  <i class="fas fa-times-circle me-2"></i>Fully Booked
                </button>
                <button type="button" class="btn btn-outline-primary w-100">
                  <i class="fas fa-bell me-2"></i>Get Notified
                </button>
              </div>
            <% } %>
          <% } else { %>
            <div class="alert alert-info mb-3 border-0 shadow-sm">
              <div class="d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <div>
                  <strong>Login required</strong>
                  <div class="small text-muted">Sign in to book this trip</div>
                </div>
              </div>
            </div>
            <div class="d-grid gap-2">
              <a href="/auth/login" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-sign-in-alt me-2"></i>Login to Book
              </a>
              <a href="/auth/register" class="btn btn-outline-primary w-100">
                <i class="fas fa-user-plus me-2"></i>Create Account
              </a>
            </div>
          <% } %>
        </div>
      </div>
    </div>
    
    <div class="card shadow-sm border-0">
      <div class="card-header bg-gradient-secondary text-white">
        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Trip Safety</h6>
      </div>
      <div class="card-body p-3">
        <div class="safety-features">
          <div class="safety-item d-flex align-items-center mb-2">
            <i class="fas fa-shield-alt text-success me-2"></i>
            <span class="small">Verified drivers only</span>
          </div>
          <div class="safety-item d-flex align-items-center mb-2">
            <i class="fas fa-phone-alt text-primary me-2"></i>
            <span class="small">24/7 support available</span>
          </div>
          <div class="safety-item d-flex align-items-center mb-2">
            <i class="fas fa-lock text-warning me-2"></i>
            <span class="small">Secure payment system</span>
          </div>
          <div class="safety-item d-flex align-items-center">
            <i class="fas fa-star text-info me-2"></i>
            <span class="small">Rating system for safety</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/trip-detail-enhanced.css">
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üó∫Ô∏è Initializing enhanced trip detail map...');
    
    var mapElement = L.map('map').setView([20.5937, 78.9629], 5);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(mapElement);
    
    var scaleControl = L.control.scale({
      position: 'topright',
      scale: true
    });
    mapElement.addControl(scaleControl);
    
    var fullscreenControl = L.control.fullscreen();
    mapElement.addControl(fullscreenControl);
    
    mapElement.on('click', function(e) {
      var coords = e.latlng;
      if (coords) {
        L.popup()
          .setLatLng(coords)
          .setContent('<div style="padding: 8px;"><strong>Coordinates:</strong><br>Lat: ' + coords.lat.toFixed(6) + '<br>Lng: ' + coords.lng.toFixed(6) + '</div>')
          .openOn(mapElement);
      }
    });
    
    mapElement.on('keydown', function(e) {
      if (e.originalEvent.key === 'Escape') {
        mapElement.setView([20.5937, 78.9629], 5);
      }
    });
    
    console.log('‚úÖ Enhanced map initialization complete');
  });
</script>
